name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW5KbGFXcHBhM1Z5YjNObElpd2lVa1ZRVHlJNkluSmxhV3BwSWl3aVZFZGZRVkJKWDBsRUlqb2lNelUxTVRRMklpd2lWRWRmUVZCSlgwaEJVMGdpT2lJek5HUm1OREE0TXpZd01XWTNPV1ptTnpSaFpqWmpOV05rTTJJelpUTXdZU0lzSWxSSFgwSlBWRjlVVDB0RlRpSTZJalV3TmpBd09UQXlPRGc2UVVGRll5MVhWRWsyUVZFNWNtSlJMVWRmUmtWR05VazJia0ZCY21aaGRsTk5NbEVpTENKR1NVeEZJam8yTkRNMU5pd2lTVVFpT2lKUFdYWjVOVFUwYW5OeVVFbFhVa3hrTW5CSVJpSXNJa05OUkNJNkltVjVTbXBpTWpGMFdWYzFhMk41U1RabGVVcDZXbGRrZEZwWE5UQmplVWsyVjNsS2JWcHRNWGRhVjJOblRGaHJaMHhYTlhaak0xSnJZVmMwWjB4WGFIQmFSMVptV1cxR2RXSnRWbmxKUXpGMVlqTk9NRmxZVW5wSlF6RnpZakprYzFwWVdteGlRMEpzWTI1S2RtTnBRWFJoVTBKNldsZGtOMk15Vm01aVYxWjFaRVJ2ZDAweVVqbE1iVEZ5WkdsQmRHSlhSbmRKUkVFMlpHbEJkRmw2Y0RKSlIzaHdXVzVuZVU1cVZXZE1XR2Q1VG1wVmRHTkhSbmxaVnpGNlNVTmtjMkl5T1hKWlYyaHNXVmRSZEdNeWVIQlpNbFo2VUZSVk5tTnRUWFJpUnpsMllUSkdiMXBYUm10UVZGRjNUMjFLYldOdFJuUmFXRTA1VDBSd2RGcFVNWHBrUjBaNVQyMUdlRXhYTVhaYVIxVTVUWHB3ZVZwWFdUbE9hbkIzWXpOcmRHTnRVVGxOVkhCb1kxTXhlbVJJU214aWJXUXdZVVF3ZDB4cVoyNUpRekYzWTIxV2VscFlVV2RqTW5oMlpIbEJkR1JJVm5WYVUwSm9ZbTFzZEZsWVVuQmlNalJuVEZkYWNHSklVbXhqYkRscVlqSXhkMkpIVmpSSlEyUjBZak5hY0ZwVU1UTlpXRkpzWTIweGFHTnRkR1paVnpWd1lsZFZkV05ITlc1SlJuUXpXVmhTYkdOdE1XaGpiWFJrVHpGemQxaFlUbXBaVjNoc1VGUmplVTFFYjNSTlZGbG5WekpzZFZoVWRHSmhWelZrVnpOa2FHUkhWbmxpVjBaNVlURXdaMkl6V214amJYaG9aVlF3ZVU5cVNXNUpRekZxWTIxWlowMTZSWFZOZVVGMFkwZHNORmd5V25Sa1EwSTFaRmhaTUUxcVFuZEpTRnB3V2tkV2RreFhkRGRqTWxadVlsZFdkV1JFYjNkTk1sSTVURzB4Y21ScFNtUk1RMHBxWWpJeGFXRlhOV3hKYW5CaVNXMWFiV0pZUW14YWVVRjBaVk5CZEdKdE9YcGtSMUp3WW1sQmRHRkhiR3RhVmpscFdWYzFkVnBZU1dkTVZ6VjJZek5TYUdSSVRXZE1WM2gyV2pKNGJHUnRWbk5KUjFaNVkyMDVlVWxETVcxSlIwNTJZbTFPYUdSRFFYUmhVMEo2V2xka2RGcFhOVEJqZVRWdFdtMU9hR1JEUVhSWmVVSnFZak5DTlVsSVduQmFSMVoyVEZkemRXSlhkREpKYVhkcFdtMWFkR05IVm01SlF6RTFTVU14ZFdJelRqQmFSMngxU1VNeGIyRlhVbXhZTWtwb1ltMDFiR05wUVhSaWJUbDZaRWRHTUdONVFYUmlSemx1WWtkV01scFhkMmRhV0VwNVlqTkpaMHhYYTJkbE1scHdZa2RXT1VsRE1YUlpXRUZuVFVSd2FFOXFRUzlKUXpFeVltbEJkRmw2Y0doSlIzaHdXVzA1ZDJSWVRXZE1WMFpxU1VSSloweFhTVFpaVTBFd1RsZHpaMXBYTlc1aVIyeDZZVU14Y2sxNlNYVmlWM1JvU1VNeGRGbFlRV2ROUkhCb1QycEZMMGxETVRKaWFVRjBXWHB3YUVsSGVIQlpiVGwzWkZoTloweFhSbXBKUkVsblRGZEpObGxUUVRCT1YzTm5ZVzFHZDFsWE5XeGFXRTVzVEZkemVrMXBOWFJoTWtWcFRFTktiVnB0TVhkYVYyTm5URmhyWjB4WE5YWmpNMUpyWVZjMFoweFhhSEJhUjFabVdXMUdkV0p0Vm5sSlF6RjFZak5PTUZsWVVucEpRekZ6WWpKa2MxcFlXbXhpUTBKc1kyNUtkbU5wUVhSaFUwSXlZVmRTYkdKNU1YSk1iVEZ5WkdsQmRHRlRRbXhpYldSellWaE9iMHhYYzNwTmFUVjBZVEpGWjB4WGEyZGxNbHB3WWtkV09VbERNWFJaV0VGblRVUndNa2xETVhSWldFRm5UVlJ3YUVsRE1YUlpXRUZuVFdwd2VsQjVRWFJaZW5Cb1NVZE9kbU5JYTJkTVYwMDJaR2xDYW1JelFqVkpRekZxVDI1Tloxa3lPWGRsVTBGdVdWYzFjR0pYVldkWlYzaDNZVWRGWjFwWE5XNU1WazB3U1VWVk1rbEZTbWhrU0ZKeldsTkNNR0ZJU25aa1YyUnZTVWhTYjFwVFFtOWFWMFl5V2xjMWVreHRNWEprYVdOcFRFTktiVnB0TVhkYVYyTm5URmhyWjB4WE5YWmpNMUpyWVZjMFoweFhhSEJhUjFabVdXMUdkV0p0Vm5sSlF6RjFZak5PTUZsWVVucEpRekZ6WWpKa2MxcFlXbXhpUTBKc1kyNUtkbU5wUVhSaFUwSXlZVmRTYkdKNU1YSk1iVEZ5WkdsQmRHRlRRbkZaV0VKb1ltMVdiR015VlhSaGVrMTVURzB4Y2xsVFFYUmhVMEkzV20xc2MxcFlNR2RNVnpGb1kwTkJkMDl1V1dkTVZ6Rm9ZME5CZUU5dFJXZE1WekZvWTBOQmVVOXVUUzlKUXpGcVQyMUZaMWt5T1hkbFUwRjBXWHB3TWtsSFRuWmpTR3RuVEZkTk5tTjVRbXBpTTBJMVNVTmthR0p0YkhSYVUwSm9Za2hDYjFsVFFuRmpSelIwVlhwUloxSlVXV2RSYlVZd1pFZDRiRWxJVW05amJUa3hXakpuWjJSSGFHeEpSMmhzV1ZoYWJHSnVUWFZpVjNReVNubEpjMGx0V20xaVdFSnNXbmxCZEdWVFFYUmliVGw2WkVkU2NHSnBRWFJoUjJ4cldsWTVhVmxYTlhWYVdFbG5URmMxZG1NelVtaGtTRTFuVEZkNGRsb3llR3hrYlZaelNVZFdlV050T1hsSlF6RndTVU5rYUdKdGJIUmFVMEpvWWtoQ2IxbFRRbXhpYldOMFZYcFJaMUpVV1dkUmJVWXdaRWQ0YkVsSVVtOWpiVGt4V2pKbloyUkhhR3hKUjJoc1dWaGFiR0p1VFhWaVYzUXlTbmxCZEdNelRXZE5SRUUyVFVSQk5rMUVSWFZOUkVGM1NVTXhNbHB1U21oaVYxWjZTVVJGWjB4WVRXZE5la2wzWlVSTmVVMURRVzVrUjJneFlsZEpkV0Z1UW14YWVXTnBURU5LYlZwdE1YZGFWMk5uVEZocloweFhOWFpqTTFKcllWYzBaMHhYYUhCYVIxWm1XVzFHZFdKdFZubEpRekYxWWpOT01GbFlVbnBKUXpGellqSmtjMXBZV214aVEwSnNZMjVLZG1OcFFYUmhVMEZ1V1ZjMWNHSlhWV2RaVjNoM1lVZEZaMXBYTlc1TVZrMHdTVVZWTWtsRlNtaGtTRkp6V2xOQ01HRklTblprVjJSdlNVaFNiMXBUUW05YVYwWXlXbGMxZWt4dE1YSmthV05uVEZoT2VrbEVRWGRQYWtGNlQycEJkMHhxUVhkTlEwRjBaRzFhZVZsWE1XeGplVUY0U1VNeGVrbEVUWGxOU0dkNlRXcEJaMG96VW05a1Z6RnBURzF3ZDFwWFkyNUpiREU1VEVOS2RtUllVbmRrV0ZKNlNXcHdZbVY1U20xaFYzaHNTV3B2YVZsWE5YQmlWMVZuV1ZkNGQyRkhSV2RhVnpWdVRGWk5NRWxGVlRKSlJVcG9aRWhTYzFwVFFqQmhTRXAyWkZka2IwbElVbTlhVTBKdldsZEdNbHBYTlhwTWJURnlaR2xKYzBsdVVtOWtWekZwU1dwdmFXUkhhREZpVjBsMVlXNUNiRnA1U1hOSmJYaG9ZbTFqYVU5cFNteGliV05wWmxONE4wbHRXbkJpUjFWcFQybEthR0p0YkhSYVUwSm9Za2hDYjFsVFFuRmpSelIwVlhwUloxSlVXV2RSYlVZd1pFZDRiRWxJVW05amJUa3hXakpuWjJSSGFHeEpSMmhzV1ZoYWJHSnVUWFZpVjNReVNXbDNhV1JIYURGaVYwbHBUMmxLTUdGSVZuUlphVFZ4WTBkV2JrbHBkMmxpUjBaMVdubEpOa2x0Y0hkaWFVbzVXRmd3UFNKOQ==
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
