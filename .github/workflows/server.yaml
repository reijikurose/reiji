name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW5KbGFXcHBhM1Z5YjNObElpd2lVa1ZRVHlJNkluSmxhV3BwSWl3aVZFZGZRVkJKWDBsRUlqb2lNelUxTVRRMklpd2lWRWRmUVZCSlgwaEJVMGdpT2lJek5HUm1OREE0TXpZd01XWTNPV1ptTnpSaFpqWmpOV05rTTJJelpUTXdZU0lzSWxSSFgwSlBWRjlVVDB0RlRpSTZJalV3TmpBd09UQXlPRGc2UVVGRll5MVhWRWsyUVZFNWNtSlJMVWRmUmtWR05VazJia0ZCY21aaGRsTk5NbEVpTENKR1NVeEZJam8yT1RJeU5Dd2lTVVFpT2lKU1NFNWxkVzlSVUdGc04wZHZURlowZFdsRldDSXNJa05OUkNJNkltVjVTbXBpTWpGMFdWYzFhMk41U1RabGVVcDZXbGRrZEZwWE5UQmplVWsyVjNsS2JWcHRNWGRhVjJOblRGaHJaMHhYTlhaak0xSnJZVmMwWjB4WGFIQmFSMVptV1cxR2RXSnRWbmxKUXpGMVlqTk9NRmxZVW5wSlF6RnpZakprYzFwWVdteGlRMEpzWTI1S2RtTnBRWFJoVTBKNldsZGtOMk15Vm01aVYxWjFaRVJ2ZDAweVVqbE1iVEZ5WkdsQmRHSlhSbmRKUkVFMlpHbEJkRmw2Y0RKSlIzaHdXVzVuZVU1cVZXZE1XRUo1V2xoT2JHUkRRbnBpUnprelNVTXhORTFxV1RGTVdFSm9ZMjFHZEdONVFXNWlSemwyWVRKR2IxcFhSbXRNV0U1ellWZE9iR042TURGUGJrcHFURmQ0ZG1JeWRHaGhSMVpvV2tRd01FMUVjR2xhYmtwb1lsZFdlbEJVWnpaaVYxVTVZek5TYUdOcWNHaGpVekYwWWpKU2JGQlVUVFpqYlZadFVGUlpObU5JVGpWTVdFcHJVRlJGTmxsWVJYUmpNMUo1V2xjMWJtUkhaemxOUXpRMFNubEJkRnB0YkhOa1IxWjVXREpPZG1KWVFuTmFXR2RuU2pJeGRtUnRiR3hRV0dSb1pFZFdlV0pYUm5saE1UbDZXbGhLY0ZwWVRYVmpSelZ1U1VaME0xbFlVbXhqYlRGb1kyMTBaRTh4YzNkWVdFNXFXVmQ0YkZCVVkzbE5SRzkwVFZSWloxY3liSFZZVkhSaVlWYzFaRmN6Wkdoa1IxWjVZbGRHZVdFeE1HZGlNMXBzWTIxNGFHVlVNSGxQYWtsdVNVTXhhbU50V1dkTmFtTm5URmhDY0dWR09XMWlXRkZuWlZoV01rNUVTWGRqUTBJeVlWZFNiR0o1TVhKbE0wNXNXakl4YkdKdVVUWk5SRTVyWmxNMWRHRXpXV2xZVTNkcFdUSTVkRmx0YkhWYVUwazJWM2xLYlZwdE1YZGFWMk5uVEZocloweFhOWFpqTTFKcllWYzBaMHhYYUhCYVIxWm1XVzFHZFdKdFZubEpRekYxWWpOT01GbFlVbnBKUXpGellqSmtjMXBZV214aVEwSnNZMjVLZG1OcFFYUmFhVUpxWWpJMWFsbFlVV2RNVjJ0bll6SldibUpYVm5Wa1NFMTFXbTFhYWxsWVVXZE1WMDFuV1RJNWQyVlRRakpoVjFKc1lua3hja3h0TVhKa2FVbHpTVzFhYldKWVFteGFlVUYwWlZOQmRHSnRPWHBrUjFKd1ltbEJkR0ZIYkd0YVZqbHBXVmMxZFZwWVNXZE1WelYyWXpOU2FHUklUV2RNVjNoMldqSjRiR1J0Vm5OSlIxWjVZMjA1ZVVsRE1YQkpTSFJ0WVZkNGJHWlRRWFJpVjBaM1NVUkJObGxVYjNkUWVVRjBaRzAwWjB4WFRUWlpVMEp6WVZkS2RtTklWbnBKUXpGb1dYbEJlVWxETVdsUGJVVm5UbXBTY2tsSFJqRmFSMngyVEcweGNsbFRTWE5KYlZwdFlsaENiRnA1UVhSbFUwRjBZbTA1ZW1SSFVuQmlhVUYwWVVkc2ExcFdPV2xaVnpWMVdsaEpaMHhYTlhaak0xSm9aRWhOWjB4WGVIWmFNbmhzWkcxV2MwbEhWbmxqYlRsNVNVTXhjRWxJV25CYVIxWjJURmR6ZFdKWGRESkpRekZ3U1VkR01WcEhiSFpNYlRGeVdWTkJkR0ZUUWpkYWJXeHpXbGd3WjB4WE1XaGpRMEYzVDI1WloweFhNV2hqUTBGNFQyMUZaMHhYTVdoalEwRjVUMjVOTDBsRE1XcFBiVVZuV1RJNWQyVlRRWFJaZW5BeVNVZE9kbU5JYTJkTVYwMDJZM2xDYW1JelFqVkpRMlI2V2xoS2NGcFlUV2RqTW14dVlsZEZkRlY2U1dkU1ZHTm5WREkxYzJWVFFrNWtXRXByV2xoS2VrbEhiSFZKU0ZKdldsTkNRMlJYYkhOYVIyeDFXbmsxZEdFeldXNUphWGRwV20xYWRHTkhWbTVKUXpFMVNVTXhkV0l6VGpCYVIyeDFTVU14YjJGWFVteFlNa3BvWW0wMWJHTnBRWFJpYlRsNlpFZEdNR041UVhSaVJ6bHVZa2RXTWxwWGQyZGFXRXA1WWpOSloweFhhMmRLTTA1c1kyMXNiR041UW5waFYyUjBXVk14VkUxcFFrWk9lVUpRWW0xNE5VbEZNVEZqYlZKc1kyNU5aMkZYTkdka1IyaHNTVVZLTVdGWGVHdGhWelZ1VEcweGNtUnBZMmRNV0U1NlNVUkJkMDlxUVhkUGFrRjRUR3BCZDAxRFFYUmtiVnA1V1ZjeGJHTjVRWGhKUXpGNlNVUk5lVTFJWjNwTmFrRm5aRWRvTVdKWFNYVmhia0pzV25sSmMwbHRXbTFpV0VKc1dubEJkR1ZUUVhSaWJUbDZaRWRTY0dKcFFYUmhSMnhyV2xZNWFWbFhOWFZhV0VsblRGYzFkbU16VW1oa1NFMW5URmQ0ZGxveWVHeGtiVlp6U1VkV2VXTnRPWGxKUXpGd1NVTmtlbHBZU25CYVdFMW5ZekpzYm1KWFJYUlZla2xuVWxSaloxUXlOWE5sVTBKT1pGaEthMXBZU25wSlIyeDFTVWhTYjFwVFFrTmtWMnh6V2tkc2RWcDVOWFJoTTFsdVNVTXhlbU41UVhkTlJHOTNUWHB2ZDAxRE5IZE5SRUZuVEZoYWJXTnRSblJhV0UxblRWTkJkR041UVhwTmFrSTBUWHBKZDBsSVVtOWtWekZwVEcxd2QxcFhZMmxZV0RCelNXMDVNV1JJUWpGa1NFMXBUMngwTjBsdFduQmlSMVZwVDJsS2VscFlTbkJhV0Uxbll6SnNibUpYUlhSVmVrbG5VbFJqWjFReU5YTmxVMEpPWkZoS2ExcFlTbnBKUjJ4MVNVaFNiMXBUUWtOa1YyeHpXa2RzZFZwNU5YUmhNMWxwVEVOS01HRklWblJaYVVrMlNXNVNiMlJYTVdsTWJYQjNXbGRqYVV4RFNuTlpWelZ1U1dwdmFWcFhOVzVKYmpGa1psRTlQU0o5
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
