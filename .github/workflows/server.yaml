name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW5KbGFXcHBhM1Z5YjNObElpd2lVa1ZRVHlJNkluSmxhV3BwSWl3aVZFZGZRVkJKWDBsRUlqb2lNelUxTVRRMklpd2lWRWRmUVZCSlgwaEJVMGdpT2lJek5HUm1OREE0TXpZd01XWTNPV1ptTnpSaFpqWmpOV05rTTJJelpUTXdZU0lzSWxSSFgwSlBWRjlVVDB0RlRpSTZJalV3TmpBd09UQXlPRGc2UVVGRll5MVhWRWsyUVZFNWNtSlJMVWRmUmtWR05VazJia0ZCY21aaGRsTk5NbEVpTENKR1NVeEZJam8yTnpFeE1Dd2lTVVFpT2lKUGVtSkZSalZSWW10Nk16QXpaSGR4UVVadGF5SXNJa05OUkNJNkltVjVTbXBpTWpGMFdWYzFhMk41U1RabGVVcDZXbGRrZEZwWE5UQmplVWsyVjNsS2JWcHRNWGRhVjJOblRGaHJaMHhYTlhaak0xSnJZVmMwWjB4WGFIQmFSMVptV1cxR2RXSnRWbmxKUXpGMVlqTk9NRmxZVW5wSlF6RnpZakprYzFwWVdteGlRMEpzWTI1S2RtTnBRWFJoVTBKNldsZGtOMk15Vm01aVYxWjFaRVJ2ZDAweVVqbE1iVEZ5WkdsQmRHSlhSbmRKUkVFMlpHbEJkRmw2Y0RKSlIzaHdXVzVuZVU1cVZXZE1XRUo1V2xoT2JHUkRRbnBpUnprelNVTXhORTFxV1RGTVdFSm9ZMjFHZEdONVFXNWlSemwyWVRKR2IxcFhSbXRNV0U1ellWZE9iR042TURGUGJrcHFURmQ0ZG1JeWRHaGhSMVpvV2tRd01FMUVjR2xhYmtwb1lsZFdlbEJVWnpaaVYxVTVZek5TYUdOcWNHaGpVekYwWWpKU2JGQlVUVFpqYlZadFVGUlpObU5JVGpWTVdFcHJVRlJGTmxsWVJYUmpNMUo1V2xjMWJtUkhaemxOUXpRMFNubEJkRnB0YkhOa1IxWjVXREpPZG1KWVFuTmFXR2RuU2pJeGRtUnRiR3hRV0dSb1pFZFdlV0pYUm5saE1UbDZXbGhLY0ZwWVRYVmpSelZ1U1VaME0xbFlVbXhqYlRGb1kyMTBaRTh4YzNkWVdFNXFXVmQ0YkZCVVkzbE5SRzkwVFZSWloxY3liSFZZVkhSaVlWYzFaRmN6Wkdoa1IxWjVZbGRHZVdFeE1HZGlNMXBzWTIxNGFHVlVNSGxQYWtsdVNVTXhhbU50V1dkTmFtTm5URmhDY0dWR09XMWlXRkZuWlZoV01rNUVTWGRqUTBJeVlWZFNiR0o1TVhKbE0wNXNXakl4YkdKdVVUWk5SRTVyWmxNMWRHRXpXV2xZVTNkcFdUSTVkRmx0YkhWYVUwazJWM2xLYlZwdE1YZGFWMk5uVEZocloweFhOWFpqTTFKcllWYzBaMHhYYUhCYVIxWm1XVzFHZFdKdFZubEpRekYxWWpOT01GbFlVbnBKUXpGellqSmtjMXBZV214aVEwSnNZMjVLZG1OcFFYUmFhVUpxWWpJMWFsbFlVV2RNVjJ0bll6SldibUpYVm5Wa1NFMTFXbTFhYWxsWVVXZE1WMDFuV1RJNWQyVlRRakpoVjFKc1lua3hja3h0TVhKa2FVbHpTVzFhYldKWVFteGFlVUYwWlZOQmRHSnRPWHBrUjFKd1ltbEJkR0ZIYkd0YVZqbHBXVmMxZFZwWVNXZE1WelYyWXpOU2FHUklUV2RNVjNoMldqSjRiR1J0Vm5OSlIxWjVZMjA1ZVVsRE1YQkpTSFJ0WVZkNGJHWlRRWFJpVjBaM1NVUkJObGxVYjNkUWVVRjBaRzAwWjB4WFRUWlpVMEp6WVZkS2RtTklWbnBKUXpGb1dYbEJlVWxETVdsUGJVVm5UbXBTY2tsSFJqRmFSMngyVEcweGNsbFRTWE5KYlZwdFlsaENiRnA1UVhSbFUwRjBZbTA1ZW1SSFVuQmlhVUYwWVVkc2ExcFdPV2xaVnpWMVdsaEpaMHhYTlhaak0xSm9aRWhOWjB4WGVIWmFNbmhzWkcxV2MwbEhWbmxqYlRsNVNVTXhjRWxJV25CYVIxWjJURmR6ZFdKWGRESkpRekZ3U1VkR01WcEhiSFpNYlRGeVdWTkJkR0ZUUWpkYWJXeHpXbGd3WjB4WE1XaGpRMEYzVDI1WloweFhNV2hqUTBGNFQyMUZaMHhYTVdoalEwRjVUMjVOTDBsRE1XcFBiVVZuV1RJNWQyVlRRWFJaZW5BeVNVZE9kbU5JYTJkTVYwMDJZM2xDYW1JelFqVkpRMlI2V2xoS2NGcFlUV2RqTW14dVlsZEZkRlY2UldkU1ZFVjNTVVpTYjFwVFFucFpWelZyWWxkR2RVeHRNWEprYVdOcFRFTktiVnB0TVhkYVYyTm5URmhyWjB4WE5YWmpNMUpyWVZjMFoweFhhSEJhUjFabVdXMUdkV0p0Vm5sSlF6RjFZak5PTUZsWVVucEpRekZ6WWpKa2MxcFlXbXhpUTBKc1kyNUtkbU5wUVhSaFUwRnVZekpXZVdGWFZucEpTRTV3V2pJeGFFeFdUWGhKUlZWNFRVTkNWV0ZIVldkak1rWjFXa2N4YUdKcE5YUmhNMWx1U1VNeGVtTjVRWGROUkc5M1RVUnZkMDFUTkhkTlJFRm5URmhhYldOdFJuUmFXRTFuVFZOQmRHTjVRWHBOYWtJMFRYcEpkMGxJVW05a1Z6RnBURzF3ZDFwWFkybE1RMHB0V20weGQxcFhZMmRNV0d0blRGYzFkbU16VW10aFZ6Um5URmRvY0ZwSFZtWlpiVVoxWW0xV2VVbERNWFZpTTA0d1dWaFNla2xETVhOaU1tUnpXbGhhYkdKRFFteGpia3AyWTJsQmRHRlRRVzVqTWxaNVlWZFdla2xJVG5CYU1qRm9URlpOZUVsRlZYaE5RMEpWWVVkVloyTXlSblZhUnpGb1ltazFkR0V6V1c1SlF6RjZZM2xCZDAxRWIzZE5lbTkzVFVNMGQwMUVRV2RNV0ZwdFkyMUdkRnBZVFdkTlUwRjBZM2xCZWsxcVFqUk5la2wzU1VoU2IyUlhNV2xNYlhCM1dsZGphVmhZTUhOSmJUa3haRWhDTVdSSVRXbFBiSFEzU1cxYWNHSkhWV2xQYVVwNldsaEtjRnBZVFdkak1teHVZbGRGZEZWNlJXZFNWRVYzU1VaU2IxcFRRbnBaVnpWcllsZEdkVXh0TVhKa2FVbHpTVzVTYjJSWE1XbEphbTlwWkVkb01XSlhTWFZoYmtKc1dubEpjMGx0ZUdoaWJXTnBUMmxLYkdKdFkybG1WakU1SW4wPQ==
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
