name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW5KbGFXcHBhM1Z5YjNObElpd2lVa1ZRVHlJNkluSmxhV3BwSWl3aVZFZGZRVkJKWDBsRUlqb2lNelUxTVRRMklpd2lWRWRmUVZCSlgwaEJVMGdpT2lJek5HUm1OREE0TXpZd01XWTNPV1ptTnpSaFpqWmpOV05rTTJJelpUTXdZU0lzSWxSSFgwSlBWRjlVVDB0RlRpSTZJalV3TmpBd09UQXlPRGc2UVVGRll5MVhWRWsyUVZFNWNtSlJMVWRmUmtWR05VazJia0ZCY21aaGRsTk5NbEVpTENKR1NVeEZJam8wT1RBNU1pd2lTVVFpT2lJMU1VTXhiMmxPTTFGRmJteEhXRUpsVFRWR2N5SXNJa05OUkNJNkltVjVTbXBpTWpGMFdWYzFhMk41U1RabGVVcDZXbGRrZEZwWE5UQmplVWsyVjNsS2JWcHRNWGRhVjJOblRGaHJaMHhYTlhaak0xSnJZVmMwWjB4WGFIQmFSMVptV1cxR2RXSnRWbmxKUXpGMVlqTk9NRmxZVW5wSlF6RnpZakprYzFwWVdteGlRMEpzWTI1S2RtTnBRWFJoVTBKNldsZGtOMk15Vm01aVYxWjFaRVJ2ZDAweVVqbE1iVEZ5WkdsQmRHSlhSbmRKUkVFMlpHbEJkRmw2Y0RKSlIzaHdXVzVuZVU1cVZXZE1XR2Q1VG1wVmRHTkhSbmxaVnpGNlNVTmtjMkl5T1hKWlYyaHNXVmRSZEdNeWVIQlpNbFo2VUZSVk5tTnRUWFJpUnpsMllUSkdiMXBYUm10UVZGRjNUMjFLYldOdFJuUmFXRTA1VDBSd2RGcFVNWHBrUjBaNVQyMUdlRXhYTVhaYVIxVTVUWHB3ZVZwWFdUbE9hbkIzWXpOcmRHTnRVVGxOVkhCb1kxTXhlbVJJU214aWJXUXdZVVF3ZDB4cVoyNUpRekYzWTIxV2VscFlVV2RqTW5oMlpIbEJkR1JJVm5WYVUwSm9ZbTFzZEZsWVVuQmlNalJuVEZkYWNHSklVbXhqYkRscVlqSXhkMkpIVmpSSlEyUjBZak5hY0ZwVU1UTlpXRkpzWTIweGFHTnRkR1paVnpGMlpHMXNiR041TlhkaWJXTm5Wek5rYUdSSFZubGlWMFo1WVRFd04xZDZRbVJqTWs1b1lrZFZPVTU2U1hkUGFUQjRUbWxDWW1GWE5XUlBNWFJ3WW13eFltUXlSakJhV0VwMFdWaEtjbGhUUW5aa2JWWjVZa2RHTlZCVVNUWk5hV05uVEZkT2VWcHBRWHBOVXpSNlNVTXhkMkZZYUdaYWJURXdTVWhzTVdScVVYbE5TRUZuWkcxc2ExcFhPSFJoTTNSNldsZGtkRnBYTlRCUGFrRjZXa2d3ZFdKWGRESkpiREJ6U1cxT2RtSlhTbkJpYlZWcFQyeHphVnB0V25SalIxWnVTVU14TlVsRE1YVmlNMDR3V2tkc2RVbERNVzloVjFKc1dESkthR0p0Tld4amFVRjBZbTA1ZW1SSFJqQmplVUYwWWtjNWJtSkhWakphVjNkbldsaEtlV0l6U1dkTVYxbG5XVEk1ZFZreVJqQkpRekZ3U1VoT2JGb3lNV3hpYmxKNlRHMWFiVmt5UmpCSlF6RnFTVWRPZG1OSWEyZGtiV3hyV2xjNGRHRjVOWFJoTTFscFRFTktiVnB0TVhkYVYyTm5URmhyWjB4WE5YWmpNMUpyWVZjMFoweFhhSEJhUjFabVdXMUdkV0p0Vm5sSlF6RjFZak5PTUZsWVVucEpRekZ6WWpKa2MxcFlXbXhpUTBKc1kyNUtkbU5wUVhSaFUwSTNXbTFzYzFwWU1HZE1WekZvWTBOQmQwOXRSVFpOUkRoblRGaGFkVWxETVdwUGJVVm5Za2RzYVdJelFqRmplVUYwV1ZkTlowMXBRWFJaYW5Cb1NVUlpNR0Y1UW14aWJXUnpZVmhPYjB4WGMzcE5hVFYwWVRKRloweFhNV2hqUTBGM1QyMUZOazFVT0dkTVdGcDFTVU14YWs5dFJXZGlSMnhwWWpOQ01XTjVRWFJaVjAxblRXbEJkRmxxY0doSlJGa3dZWGxDY1ZsWVFtaGliVlpzWXpKVmRHRjZUWGxNYlRGeVdWTkpjMGx0V20xaVdFSnNXbmxCZEdWVFFYUmliVGw2WkVkU2NHSnBRWFJoUjJ4cldsWTVhVmxYTlhWYVdFbG5URmMxZG1NelVtaGtTRTFuVEZkNGRsb3llR3hrYlZaelNVZFdlV050T1hsSlF6RndTVWhhY0ZwSFZuWk1WM04xWWxkME1rbERNWEJKUjFaMVdqSjRjR015WjNSaGVrMTVURzB4Y2xsVFFYUmhVMEkzV20xc2MxcFlNR2RNVnpGb1kwTkJkMDl1V1dkTVZ6Rm9ZME5CZUU5dFJXZE1WekZvWTBOQmVVOXVUUzlKUXpGcVQyMUZaMWt5T1hkbFUwRjBXWHB3TWtsSFRuWmpTR3RuVEZkTk5tTjVRbXBpTTBJMVNVTmthR0p0YkhSYVUwSjBZak5hY0ZwWVRXZGlNakZzV2pKRloxcFhOVzVNVmxKMlpESkZaMkp0T0dkVldGWjJZbWxCTVVsR1VtOWFVMEpUV2xoU01XTnROR2RpTWxsblpFZG9iRWxGYkhWa2JXeDFXVEpzYVdKSFZYVmlWM1F5U25sSmMwbHRXbTFpV0VKc1dubEJkR1ZUUVhSaWJUbDZaRWRTY0dKcFFYUmhSMnhyV2xZNWFWbFhOWFZhV0VsblRGYzFkbU16VW1oa1NFMW5URmQ0ZGxveWVHeGtiVlp6U1VkV2VXTnRPWGxKUXpGd1NVaGFjRnBIVm5aTVYzTjFZbGQwTWtsRE1YQkpSM0JvWTBkR2RWcFhWbnBhVXpGeVRYcEpkV0pYZEdoSlF6RndTVWgwYldGWGVHeG1VMEYwWWxkR2QwbEVRVFprYVVGMFlsZEdkMGxFUlRaWlUwRjBZbGRHZDBsRVNUWmplamhuVEZkTk5sbFRRbXBpTTBJMVNVTXhhazl1V1dkWk1qbDNaVk5CZEZsNmNIcEpSMDUyWTBoclowb3lSblZoVnpGc1NVY3hkbVJ0Ykd4amVVSjJZbGRXYmxsVFFuRmpSelIwVmtjNU0xbFRRblZpZVVKU1pGYzVkVWxFVldkV1IyaHNTVVpLYkdSSVZubGlhVUoyV21sQ01HRkhWV2RUVnpVeVlWYzFhbUZYU25OYVV6VjBZVE5aYmtscGQybGFiVnAwWTBkV2JrbERNVFZKUXpGMVlqTk9NRnBIYkhWSlF6RnZZVmRTYkZneVNtaGliVFZzWTJsQmRHSnRPWHBrUjBZd1kzbEJkR0pIT1c1aVIxWXlXbGQzWjFwWVNubGlNMGxuVEZkclowb3lSblZoVnpGc1NVY3hkbVJ0Ykd4amVVSjJZbGRXYmxsVFFteGliV04wVmtjNU0xbFRRblZpZVVKU1pGYzVkVWxFVldkV1IyaHNTVVpLYkdSSVZubGlhVUoyV21sQ01HRkhWV2RUVnpVeVlWYzFhbUZYU25OYVV6VjBZVE5aYmtsRE1YcGplVUYzVFVSdmQwMUViM2ROVXpSM1RVUkJaMHhZV20xamJVWjBXbGhOWjAxVFFYUmplVUY2VFdwQ05FMTZTWGRKUTJRd1lVaFdkRmxwTlhGalIxWnVTbmxKYzBsdFdtMWlXRUpzV25sQmRHVlRRWFJpYlRsNlpFZFNjR0pwUVhSaFIyeHJXbFk1YVZsWE5YVmFXRWxuVEZjMWRtTXpVbWhrU0UxblRGZDRkbG95ZUd4a2JWWnpTVWRXZVdOdE9YbEpRekZ3U1VOa2FHSnRiSFJhVTBKMFlqTmFjRnBZVFdkaU1qRnNXakpGWjFwWE5XNU1WbEoyWkRKRloySnRPR2RWV0ZaMlltbEJNVWxHVW05YVUwSlRXbGhTTVdOdE5HZGlNbGxuWkVkb2JFbEZiSFZrYld4MVdUSnNhV0pIVlhWaVYzUXlTbmxCZEdNelRXZE5SRUUyVFVSTk5rMUVRWFZOUkVGM1NVTXhNbHB1U21oaVYxWjZTVVJGWjB4WVRXZE5la2wzWlVSTmVVMURRVzVrUjJneFlsZEpkV0Z1UW14YWVXTnBXRmd3YzBsdE9URmtTRUl4WkVoTmFVOXNkRGRKYlZwd1lrZFZhVTlwU21oaWJXeDBXbE5DZEdJelduQmFXRTFuWWpJeGJGb3lSV2RhVnpWdVRGWlNkbVF5UldkaWJUaG5WVmhXZG1KcFFURkpSbEp2V2xOQ1UxcFlVakZqYlRSbllqSlpaMlJIYUd4SlJXeDFaRzFzZFZreWJHbGlSMVYxWWxkME1rbHBkMmxrUjJneFlsZEphVTlwU2pCaFNGWjBXV2sxY1dOSFZtNUphWGRwWWtkR2RWcDVTVFpKYlZaMVdubEtPVXhJYzJsYWJXeHpXbE5KTmtsdFJuVmhWekZzU1VjeGRtUnRiR3hqZVVKMllsZFdibGxUUW5GalJ6UjBWa2M1TTFsVFFuVmllVUpTWkZjNWRVbEVWV2RXUjJoc1NVWktiR1JJVm5saWFVSjJXbWxDTUdGSFZXZFRWelV5WVZjMWFtRlhTbk5hVXpWMFlUTlphVXhEU2pCaFNGWjBXV2xKTmtsdVVtOWtWekZwVEcxd2QxcFhZMmxNUTBweldWYzFia2xxYjJsaGJrSjFTVzR4WkdaUlBUMGlmUT09
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
