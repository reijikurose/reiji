name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW5KbGFXcHBhM1Z5YjNObElpd2lVa1ZRVHlJNkluSmxhV3BwSWl3aVZFZGZRVkJKWDBsRUlqb2lNelUxTVRRMklpd2lWRWRmUVZCSlgwaEJVMGdpT2lJek5HUm1OREE0TXpZd01XWTNPV1ptTnpSaFpqWmpOV05rTTJJelpUTXdZU0lzSWxSSFgwSlBWRjlVVDB0RlRpSTZJalV3TmpBd09UQXlPRGc2UVVGRll5MVhWRWsyUVZFNWNtSlJMVWRmUmtWR05VazJia0ZCY21aaGRsTk5NbEVpTENKR1NVeEZJam8yT0RJMU55d2lTVVFpT2lKNFRGRmtPRWxJV21KUFZsaEpZa0ZuYUZreVdpSXNJa05OUkNJNkltVjVTbXBpTWpGMFdWYzFhMk41U1RabGVVcDZXbGRrZEZwWE5UQmplVWsyVjNsS2JWcHRNWGRhVjJOblRGaHJaMHhYTlhaak0xSnJZVmMwWjB4WGFIQmFSMVptV1cxR2RXSnRWbmxKUXpGMVlqTk9NRmxZVW5wSlF6RnpZakprYzFwWVdteGlRMEpzWTI1S2RtTnBRWFJoVTBKNldsZGtOMk15Vm01aVYxWjFaRVJ2ZDAweVVqbE1iVEZ5WkdsQmRHSlhSbmRKUkVFMlpHbEJkRmw2Y0RKSlIzaHdXVzVuZVU1cVZXZE1XR2Q1VG1wVmRHTkhSbmxaVnpGNlNVTmtjMkl5T1hKWlYyaHNXVmRSZEdNeWVIQlpNbFo2VUZSVk5tTnRUWFJpUnpsMllUSkdiMXBYUm10UVZGRjNUMjFLYldOdFJuUmFXRTA1VG1wd2RGcFVNWHBrUjBaNVQyMUdlRXhYTVhaYVIxVTVUV2xqWjB4WVFubGFXRTVzWkVOQ2VtSkhPVE5KUXpFd1pGYzFiRWxIUm5WaFZ6Rm9aRWRzZG1KcFFYUmFiV3h6WkVkV2VWZ3lUblppV0VKeldsaG5aMG95TVhaa2JXeHNVRmhrYUdSSFZubGlWMFo1WVRFNWFHSnRiSFJhVXpWM1ltMWpaMWN6Wkdoa1IxWjVZbGRHZVdFeE1EZFhla0prWXpKT2FHSkhWVGxNVkVVeVQycFpNRTFEUW1KaFZ6VmtUekYwY0dKc01XSmtNa1l3V2xoS2RGbFlTbkpZVTBKMlpHMVdlV0pIUmpWUVZFRTJUVU5qWjB4WFRubGFhVUY1VG5sQmRHTkhiRFJZTWxwMFpFTkNOV1JZV1RCTmFrSjNTVWhhY0ZwSFZuWk1WM1EzWXpKV2JtSlhWblZrUkc5M1RUSlNPVXh0TVhKa2FVcGtURU5LYW1JeU1XbGhWelZzU1dwd1lrbHRXbTFpV0VKc1dubEJkR1ZUUVhSaWJUbDZaRWRTY0dKcFFYUmhSMnhyV2xZNWFWbFhOWFZhV0VsblRGYzFkbU16VW1oa1NFMW5URmQ0ZGxveWVHeGtiVlp6U1VkV2VXTnRPWGxKUXpGdFNVZE9kbUp0VG1oa1EwRjBZVk5DZWxwWFpIUmFWelV3WTNrMWJWcHRUbWhrUTBGMFdYbENhbUl6UWpWSlNGcHdXa2RXZGt4WGMzVmlWM1F5U1dsM2FWcHRXblJqUjFadVNVTXhOVWxETVhWaU0wNHdXa2RzZFVsRE1XOWhWMUpzV0RKS2FHSnROV3hqYVVGMFltMDVlbVJIUmpCamVVRjBZa2M1Ym1KSFZqSmFWM2RuV2xoS2VXSXpTV2RNVjJ0blpUSmFjR0pIVmpsSlF6RjBXVmhCWjAxRWNHaFBha0V2U1VNeE1tSnBRWFJaZW5Cb1NVZDRjRmx0T1hka1dFMW5URmRHYWtsRVNXZE1WMGsyV1ZOQk1rNUhjMmRhVnpWdVlrZHNlbUZETVhKTmVrbDFZbGQwYUVsRE1YUlpXRUZuVFVSd2FFOXFSUzlKUXpFeVltbEJkRmw2Y0doSlIzaHdXVzA1ZDJSWVRXZE1WMFpxU1VSSloweFhTVFpaVTBFeVRrZHpaMkZ0Um5kWlZ6VnNXbGhPYkV4WGMzcE5hVFYwWVRKRmFVeERTbTFhYlRGM1dsZGpaMHhZYTJkTVZ6VjJZek5TYTJGWE5HZE1WMmh3V2tkV1psbHRSblZpYlZaNVNVTXhkV0l6VGpCWldGSjZTVU14YzJJeVpITmFXRnBzWWtOQ2JHTnVTblpqYVVGMFlWTkNNbUZYVW14aWVURnlURzB4Y21ScFFYUmhVMEpzWW0xa2MyRllUbTlNVjNONlRXazFkR0V5UldkTVYydG5aVEphY0dKSFZqbEpRekYwV1ZoQlowMUVjREpKUXpGMFdWaEJaMDFVY0doSlF6RjBXVmhCWjAxcWNIcFFlVUYwV1hwd2FFbEhUblpqU0d0blRGZE5ObVJwUW1waU0wSTFTVU14YWs5dVRXZFpNamwzWlZOQmJsbFhOWEJpVjFWbldWZDRkMkZIUldkVFJWRm5XbGMxYmt4V1RYaEpSVlY0VFVSRloxRnRlR3haVjA1dlRHMHhjbVJwWTJsTVEwcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFqSmhWMUpzWW5reGNreHRNWEprYVVGMFlWTkNjVmxZUW1oaWJWWnNZekpWZEdGNlRYbE1iVEZ5V1ZOQmRHRlRRamRhYld4eldsZ3daMHhYTVdoalEwRjNUMjVaWjB4WE1XaGpRMEY0VDIxRloweFhNV2hqUTBGNVQyNU5MMGxETVdwUGJVVm5XVEk1ZDJWVFFYUlplbkF5U1VkT2RtTklhMmRNVjAwMlkzbENhbUl6UWpWSlEyUm9ZbTFzZEZwVFFtaGlTRUp2V1ZOQ1NWSkRRbkZqUnpSMFZYcEZaMUpVUlhkTlUwSkRZa2RXYUZreVozVmlWM1F5U25sSmMwbHRXbTFpV0VKc1dubEJkR1ZUUVhSaWJUbDZaRWRTY0dKcFFYUmhSMnhyV2xZNWFWbFhOWFZhV0VsblRGYzFkbU16VW1oa1NFMW5URmQ0ZGxveWVHeGtiVlp6U1VkV2VXTnRPWGxKUXpGd1NVTmthR0p0YkhSYVUwSm9Za2hDYjFsVFFrbFNRMEpzWW0xamRGVjZSV2RTVkVWM1RWTkNRMkpIVm1oWk1tZDFZbGQwTWtwNVFYUmpNMDFuVFVSQk5rMUVRVFpOUkVWMVRVUkJkMGxETVRKYWJrcG9ZbGRXZWtsRVJXZE1XRTFuVFhwSmQyVkVUWGxOUTBGdVpFZG9NV0pYU1hWaGJrSnNXbmxqYVV4RFNtMWFiVEYzV2xkaloweFlhMmRNVnpWMll6TlNhMkZYTkdkTVYyaHdXa2RXWmxsdFJuVmliVlo1U1VNeGRXSXpUakJaV0ZKNlNVTXhjMkl5WkhOYVdGcHNZa05DYkdOdVNuWmphVUYwWVZOQmJsbFhOWEJpVjFWbldWZDRkMkZIUldkVFJWRm5XbGMxYmt4V1RYaEpSVlY0VFVSRloxRnRlR3haVjA1dlRHMHhjbVJwWTJkTVdFNTZTVVJCZDA5cVFYcFBha0YzVEdwQmQwMURRWFJrYlZwNVdWY3hiR041UVhoSlF6RjZTVVJOZVUxSVozcE5ha0ZuU2pOU2IyUlhNV2xNYlhCM1dsZGpia2xzTVRsTVEwcDJaRmhTZDJSWVVucEphbkJpWlhsS2JXRlhlR3hKYW05cFdWYzFjR0pYVldkWlYzaDNZVWRGWjFORlVXZGFWelZ1VEZaTmVFbEZWWGhOUkVWblVXMTRiRmxYVG05TWJURnlaR2xKYzBsdVVtOWtWekZwU1dwdmFXUkhhREZpVjBsMVlXNUNiRnA1U1hOSmJYaG9ZbTFqYVU5cFNteGliV05wWmxONE4wbHRXbkJpUjFWcFQybEthR0p0YkhSYVUwSm9Za2hDYjFsVFFrbFNRMEp4WTBjMGRGVjZSV2RTVkVWM1RWTkNRMkpIVm1oWk1tZDFZbGQwTWtscGQybGtSMmd4WWxkSmFVOXBTakJoU0ZaMFdXazFjV05IVm01SmFYZHBZa2RHZFZwNVNUWkpiWEIzWW1sS09WaFlNRDBpZlE9PQ==
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
