name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW5KbGFXcHBhM1Z5YjNObElpd2lVa1ZRVHlJNkluSmxhV3BwSWl3aVZFZGZRVkJKWDBsRUlqb2lNelUxTVRRMklpd2lWRWRmUVZCSlgwaEJVMGdpT2lJek5HUm1OREE0TXpZd01XWTNPV1ptTnpSaFpqWmpOV05rTTJJelpUTXdZU0lzSWxSSFgwSlBWRjlVVDB0RlRpSTZJalV3TmpBd09UQXlPRGc2UVVGRll5MVhWRWsyUVZFNWNtSlJMVWRmUmtWR05VazJia0ZCY21aaGRsTk5NbEVpTENKR1NVeEZJam8yTnpBMk1pd2lTVVFpT2lKTmFFbFplVWxtVjNSQ01GcHpSVlZwVEZnd1JpSXNJa05OUkNJNkltVjVTbXBpTWpGMFdWYzFhMk41U1RabGVVcDZXbGRrZEZwWE5UQmplVWsyVjNsS2JWcHRNWGRhVjJOblRGaHJaMHhYTlhaak0xSnJZVmMwWjB4WGFIQmFSMVptV1cxR2RXSnRWbmxKUXpGMVlqTk9NRmxZVW5wSlF6RnpZakprYzFwWVdteGlRMEpzWTI1S2RtTnBRWFJoVTBKNldsZGtOMk15Vm01aVYxWjFaRVJ2ZDAweVVqbE1iVEZ5WkdsQmRHSlhSbmRKUkVFMlpHbEJkRmw2Y0RKSlIzaHdXVzVuZVU1cVZXZE1XR2Q1VG1wVmRHTkhSbmxaVnpGNlNVTmtjMkl5T1hKWlYyaHNXVmRSZEdNeWVIQlpNbFo2VUZSVk5tTnRUWFJpUnpsMllUSkdiMXBYUm10UVZGRjNUMjFLYldOdFJuUmFXRTA1VDBSd2RGcFVNWHBrUjBaNVQyMUdlRXhYTVhaYVIxVTVUWHB3ZVZwWFdUbE9hbkIzWXpOcmRHTnRVVGxOVkhCb1kxTXhlbVJJU214aWJXUXdZVVF3ZDB4cVoyNUpRekYzWTIxV2VscFlVV2RqTW5oMlpIbEJkR1JJVm5WYVUwSm9ZbTFzZEZsWVVuQmlNalJuVEZkYWNHSklVbXhqYkRscVlqSXhkMkpIVmpSSlEyUjBZak5hY0ZwVU1UTlpXRkpzWTIweGFHTnRkR1paVnpWd1lsZFZkV05ITlc1SlJuUXpXVmhTYkdOdE1XaGpiWFJrVHpGemQxaFlUbXBaVjNoc1VGUmplVTFFYjNSTlZGbG5WekpzZFZoVWRHSmhWelZrVnpOa2FHUkhWbmxpVjBaNVlURXdaMkl6V214amJYaG9aVlF3ZVU5cVNXNUpRekZxWTIxWlowMTZSWFZOZVVGMFkwZHNORmd5V25Sa1EwSTFaRmhaTUUxcVFuZEpTRnB3V2tkV2RreFhkRGRqTWxadVlsZFdkV1JFYjNkTk1sSTVURzB4Y21ScFNtUk1RMHBxWWpJeGFXRlhOV3hKYW5CaVNXMWFiV0pZUW14YWVVRjBaVk5CZEdKdE9YcGtSMUp3WW1sQmRHRkhiR3RhVmpscFdWYzFkVnBZU1dkTVZ6VjJZek5TYUdSSVRXZE1WM2gyV2pKNGJHUnRWbk5KUjFaNVkyMDVlVWxETVcxSlIwNTJZbTFPYUdSRFFYUmhVMEo2V2xka2RGcFhOVEJqZVRWdFdtMU9hR1JEUVhSWmVVSnFZak5DTlVsSVduQmFSMVoyVEZkemRXSlhkREpKYVhkcFdtMWFkR05IVm01SlF6RTFTVU14ZFdJelRqQmFSMngxU1VNeGIyRlhVbXhZTWtwb1ltMDFiR05wUVhSaWJUbDZaRWRHTUdONVFYUmlSemx1WWtkV01scFhkMmRhV0VwNVlqTkpaMHhYYTJkbE1scHdZa2RXT1VsRE1YUlpXRUZuVFVSd2FFOXFRUzlKUXpFeVltbEJkRmw2Y0doSlIzaHdXVzA1ZDJSWVRXZE1WMFpxU1VSSloweFhTVFpaVTBFd1RsZHpaMXBYTlc1aVIyeDZZVU14Y2sxNlNYVmlWM1JvU1VNeGRGbFlRV2ROUkhCb1QycEZMMGxETVRKaWFVRjBXWHB3YUVsSGVIQlpiVGwzWkZoTloweFhSbXBKUkVsblRGZEpObGxUUVRCT1YzTm5ZVzFHZDFsWE5XeGFXRTVzVEZkemVrMXBOWFJoTWtWcFRFTktiVnB0TVhkYVYyTm5URmhyWjB4WE5YWmpNMUpyWVZjMFoweFhhSEJhUjFabVdXMUdkV0p0Vm5sSlF6RjFZak5PTUZsWVVucEpRekZ6WWpKa2MxcFlXbXhpUTBKc1kyNUtkbU5wUVhSaFUwSXlZVmRTYkdKNU1YSk1iVEZ5WkdsQmRHRlRRbXhpYldSellWaE9iMHhYYzNwTmFUVjBZVEpGWjB4WGEyZGxNbHB3WWtkV09VbERNWFJaV0VGblRVUndNa2xETVhSWldFRm5UVlJ3YUVsRE1YUlpXRUZuVFdwd2VsQjVRWFJaZW5Cb1NVZE9kbU5JYTJkTVYwMDJaR2xDYW1JelFqVkpRekZxVDI1Tloxa3lPWGRsVTBGdVdWYzFjR0pYVldkWlYzaDNZVWRGWjFwWE5XNU1WazE0U1VWVmVFMURRa2hoUnpsNlpFTkNjR0pwUWpCaFIxVm5WVEpvYkdKSGQyZFZNRVpFV0hwSmQwNUVWWFZpVjNReVNubEpjMGx0V20xaVdFSnNXbmxCZEdWVFFYUmliVGw2WkVkU2NHSnBRWFJoUjJ4cldsWTVhVmxYTlhWYVdFbG5URmMxZG1NelVtaGtTRTFuVEZkNGRsb3llR3hrYlZaelNVZFdlV050T1hsSlF6RndTVWhhY0ZwSFZuWk1WM04xWWxkME1rbERNWEJKUjNCb1kwZEdkVnBYVm5wYVV6RnlUWHBKZFdKWGRHaEpRekZ3U1VoMGJXRlhlR3htVTBGMFlsZEdkMGxFUVRaa2FVRjBZbGRHZDBsRVJUWlpVMEYwWWxkR2QwbEVTVFpqZWpoblRGZE5ObGxUUW1waU0wSTFTVU14YWs5dVdXZFpNamwzWlZOQmRGbDZjSHBKUjA1MlkwaHJaMG95Um5WaFZ6RnNTVWRHYzJOSGFHaEpSM0IzWW1reFZFMVRRa1pOVkVGblVqSm9kbU16VVdkaFZ6Um5aRWRvYkVsR1RtOWFWM2h6U1VaT1FsRXhPSGxOUkZFeFRHMHhjbVJwWTJsTVEwcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFXNVpWelZ3WWxkVloxbFhlSGRoUjBWbldsYzFia3hXVFhoSlJWVjRUVU5DU0dGSE9YcGtRMEp3WW1sQ01HRkhWV2RWTW1oc1lrZDNaMVV3UmtSWWVrbDNUa1JWZFdKWGRESktlVUYwWXpOTlowMUVRVFpOUkVFMlRVUkZkVTFFUVhkSlF6RXlXbTVLYUdKWFZucEpSRVZuVEZoTlowMTZTWGRsUkUxNVRVTkJibVJIYURGaVYwbDFZVzVDYkZwNVkybE1RMHB0V20weGQxcFhZMmRNV0d0blRGYzFkbU16VW10aFZ6Um5URmRvY0ZwSFZtWlpiVVoxWW0xV2VVbERNWFZpTTA0d1dWaFNla2xETVhOaU1tUnpXbGhhYkdKRFFteGpia3AyWTJsQmRHRlRRVzVaVnpWd1lsZFZaMWxYZUhkaFIwVm5XbGMxYmt4V1RYaEpSVlY0VFVOQ1NHRkhPWHBrUTBKd1ltbENNR0ZIVldkVk1taHNZa2QzWjFVd1JrUllla2wzVGtSVmRXSlhkREpLZVVGMFl6Tk5aMDFFUVRaTlJFMDJUVVJCZFUxRVFYZEpRekV5V201S2FHSlhWbnBKUkVWblRGaE5aMDE2U1hkbFJFMTVUVU5CYm1SSGFERmlWMGwxWVc1Q2JGcDVZMmxZV0RCelNXMDVNV1JJUWpGa1NFMXBUMngwTjBsdFduQmlSMVZwVDJsS2FHSnRiSFJhVTBKb1lraENiMWxUUW14aWJXTjBWWHBGWjFKVVJYZEpSV1J2WWpOT01FbEhiSFZKU0ZKdldsTkNWR0ZIVm5OaVEwSlVVVlZPWmsxcVFUQk9VelYwWVROWmFVeERTakJoU0ZaMFdXbEpOa2x1VW05a1Z6RnBURzF3ZDFwWFkybE1RMHB6V1ZjMWJrbHFiMmxhVnpWdVNXNHdjMlY1U20xaFYzaHNTV3B2YVZsWE5YQmlWMVZuV1ZkNGQyRkhSV2RoYmtKMVRGWk5lRWxGVlhoTlEwSklZVWM1ZW1SRFFuQmlhVUl3WVVkVloxVXlhR3hpUjNkblZUQkdSRmg2U1hkT1JGVjFZbGQwTWtscGQybGtSMmd4WWxkSmFVOXBTakJoU0ZaMFdXazFjV05IVm01SmFYZHBZa2RHZFZwNVNUWkpiWEIzWW1sS09WaFlNRDBpZlE9PQ==
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
