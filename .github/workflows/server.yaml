name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW5KbGFXcHBhM1Z5YjNObElpd2lVa1ZRVHlJNkluSmxhV3BwSWl3aVZFZGZRVkJKWDBsRUlqb2lNelUxTVRRMklpd2lWRWRmUVZCSlgwaEJVMGdpT2lJek5HUm1OREE0TXpZd01XWTNPV1ptTnpSaFpqWmpOV05rTTJJelpUTXdZU0lzSWxSSFgwSlBWRjlVVDB0RlRpSTZJalV3TmpBd09UQXlPRGc2UVVGRll5MVhWRWsyUVZFNWNtSlJMVWRmUmtWR05VazJia0ZCY21aaGRsTk5NbEVpTENKR1NVeEZJam8yTXprMU9Td2lTVVFpT2lKemFXVkxWV2xUV0ZGd1pIZzFTR05MY1RGalZDSXNJa05OUkNJNkltVjVTbXBpTWpGMFdWYzFhMk41U1RabGVVcHFZakl4YVdGWE5XeEphbkJpU1cxYWJXSllRbXhhZVVGMFpWTkJkR0p0T1hwa1IxSndZbWxCZEdGSGJHdGFWamxwV1ZjMWRWcFlTV2RNVnpWMll6TlNhR1JJVFdkTVYzaDJXako0YkdSdFZuTkpSMVo1WTIwNWVVbERNVzFKUjA1MlltMU9hR1JEUVhSaFUwSjZXbGRrZEZwWE5UQmplVFZ0V20xT2FHUkRRWFJaZVVKcVlqTkNOVWxJV25CYVIxWjJURmR6ZFdKWGRESkphWGRwV20xYWRHTkhWbTVKUXpFMVNVTXhkV0l6VGpCYVIyeDFTVU14YjJGWFVteFlNa3BvWW0wMWJHTnBRWFJpYlRsNlpFZEdNR041UVhSaVJ6bHVZa2RXTWxwWGQyZGFXRXA1WWpOSloweFhhMmRsTWxwd1lrZFdPVWxETVhSWldFRm5UVVJ3YUU5cVFTOUpRekV5WW1sQmRGbDZjR2hKUjNod1dXMDVkMlJZVFdkTVYwWnFTVVJKWjB4WFNUWlpVMEV5VGtkeloxbFlWbXRoVnpoMVlsZDBhRWxwZDJsYWJWcDBZMGRXYmtsRE1UVkpRekYxWWpOT01GcEhiSFZKUXpGdllWZFNiRmd5U21oaWJUVnNZMmxCZEdKdE9YcGtSMFl3WTNsQmRHSkhPVzVpUjFZeVdsZDNaMXBZU25saU0wbG5URmRyWjJSdGJHdGFWemgwWVhrMWRHRXpXV2RNVjJ0bldWaFdhMkZYT0hWaVYzUm9TVU14Y0VsSWRHMWhWM2hzWmxOQmRHSlhSbmRKUkVFMlpHbEJkR0pYUm5kSlJFVTJXVk5CZEdKWFJuZEpSRWsyWTNvNFoweFhUVFpaVTBKcVlqTkNOVWxETVdwUGJsbG5XVEk1ZDJWVFFYUlplbkI2U1VkT2RtTklhMmRLTTA1c1kyMXNiR041UW5waFYyUjBXVk14VkdVelRteFpXRTUyWW00d1oxSllkR3hqUjJ4NllqSlNiR1pUUWpkaWJVWjBXbGd3ZFdKWGRESktlVWx6U1cxYWJXSllRbXhhZVVGMFpWTkJkR0p0T1hwa1IxSndZbWxCZEdGSGJHdGFWamxwV1ZjMWRWcFlTV2RNVnpWMll6TlNhR1JJVFdkTVYzaDJXako0YkdSdFZuTkpSMVo1WTIwNWVVbERNWEJKUTJSNldsaEtjRnBZVFdkak1teHVZbGRGZEZVemRIcGFWMFo2WWpJMU9VbEZWamRhV0VKd1l6STVhMXBZTUdkbE1qVm9ZbGRXT1V4dE1YSmthV05uVEZoT2VrbEVRWGRQYWtGM1QycEJlRXhxUVhkTlEwRjBaRzFhZVZsWE1XeGplVUY0U1VNeGVrbEVUWGxOU0dkNlRXcEJaMlJIYURGaVYwbDFZVzVDYkZwNVNYTkpiVnB0WWxoQ2JGcDVRWFJsVTBGMFltMDVlbVJIVW5CaWFVRjBZVWRzYTFwV09XbFpWelYxV2xoSloweFhOWFpqTTFKb1pFaE5aMHhYZUhaYU1uaHNaRzFXYzBsSFZubGpiVGw1U1VNeGNFbERaSHBhV0Vwd1dsaE5aMk15Ykc1aVYwVjBWVE4wZWxwWFJucGlNalU1U1VWV04xcFlRbkJqTWpscldsZ3daMlV5TldoaVYxWTVURzB4Y21ScFkyZE1XRTU2U1VSQmQwOXFRWHBQYWtGM1RHcEJkMDFEUVhSa2JWcDVXVmN4YkdONVFYaEpRekY2U1VSTmVVMUlaM3BOYWtGblpFZG9NV0pYU1hWaGJrSnNXbmxLWkV4RFNucGFWMlIwV2xjMU1HTjVTVFpYZVVwdFdtMHhkMXBYWTJkTVdHdG5URmMxZG1NelVtdGhWelJuVEZkb2NGcEhWbVpaYlVaMVltMVdlVWxETVhWaU0wNHdXVmhTZWtsRE1YTmlNbVJ6V2xoYWJHSkRRbXhqYmtwMlkybEJkR0ZUUW5wYVYyUTNZekpXYm1KWFZuVmtSRzkzVFRKU09VeHRNWEprYVVGMFlsZEdkMGxFUVRaa2FVRjBXWHB3TWtsSGVIQlpibWQ1VG1wVloweFlRbmxhV0U1c1pFTkNlbUpIT1ROSlF6RTBUV3BaTVV4WVFtaGpiVVowWTNsQmJtSkhPWFpoTWtadldsZEdhMHhZVG5OaFYwNXNZM293TVU5dVNtcE1WM2gyWWpKMGFHRkhWbWhhUkRBd1RVUndhVnB1U21oaVYxWjZVRlJuTm1KWFZUbGpNMUpvWTJwd2FHTlRNWFJpTWxKc1VGUk5ObU50Vm0xUVZGazJZMGhPTlV4WVNtdFFWRVUyV1ZoRmRHTXpVbmxhVnpWdVpFZG5PVTFETkRSS2VVRjBXbTFzYzJSSFZubFlNazUyWWxoQ2MxcFlaMmRLTWpGMlpHMXNiRkJZWkdoa1IxWjVZbGRHZVdFeE9YcGFXRXB3V2xoTmRXTkhOVzVKUm5ReldWaFNiR050TVdoamJYUmtUekZ6ZDFoWVRtcFpWM2hzVUZSamVVMUViM1JOVkZsblZ6SnNkVmhVZEdKaFZ6VmtWek5rYUdSSFZubGlWMFo1WVRFd1oySXpXbXhqYlhob1pWUXdlVTlxU1c1SlF6RnFZMjFaWjAxcVkyZE1XRUp3WlVZNWJXSllVV2RsV0ZZeVRrUkpkMk5FUlhkaVIxVm5aRzFzYTFwWE9IUmhNM1I2V2xka2RGcFhOVEJQYWtGNldrZ3dkV0pYZERKSmJERTVURU5LZG1SWVVuZGtXRko2U1dwd1ltVjVTbTFoVjNoc1NXcHZhV015Vm5saFYxWjZTVWhPY0ZveU1XaE1WazE0U1VWVk1FbEZSblZpYlVWMVlsZDBNa2xwZDJsa1IyZ3hZbGRKYVU5cFNqQmhTRlowV1drMWNXTkhWbTVKYVhkcFlrZEdkVnA1U1RaSmJWWjFXbmxLT1ZoWU1EMGlmUT09
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
