name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW5KbGFXcHBhM1Z5YjNObElpd2lVa1ZRVHlJNkluSmxhV3BwSWl3aVZFZGZRVkJKWDBsRUlqb2lNelUxTVRRMklpd2lWRWRmUVZCSlgwaEJVMGdpT2lJek5HUm1OREE0TXpZd01XWTNPV1ptTnpSaFpqWmpOV05rTTJJelpUTXdZU0lzSWxSSFgwSlBWRjlVVDB0RlRpSTZJalV3TmpBd09UQXlPRGc2UVVGRll5MVhWRWsyUVZFNWNtSlJMVWRmUmtWR05VazJia0ZCY21aaGRsTk5NbEVpTENKR1NVeEZJam8yTXprd01Td2lTVVFpT2lKVldFVmhSbk5NVVZoWFpERlBjR0ZHUmtoT1ZpSXNJa05OUkNJNkltVjVTbXBpTWpGMFdWYzFhMk41U1RabGVVcHFZakl4YVdGWE5XeEphbkJpU1cxYWJXSllRbXhhZVVGMFpWTkJkR0p0T1hwa1IxSndZbWxCZEdGSGJHdGFWamxwV1ZjMWRWcFlTV2RNVnpWMll6TlNhR1JJVFdkTVYzaDJXako0YkdSdFZuTkpSMVo1WTIwNWVVbERNVzFKUjA1MlltMU9hR1JEUVhSaFUwSjZXbGRrZEZwWE5UQmplVFZ0V20xT2FHUkRRWFJaZVVKcVlqTkNOVWxJV25CYVIxWjJURmR6ZFdKWGRESkphWGRwV20xYWRHTkhWbTVKUXpFMVNVTXhkV0l6VGpCYVIyeDFTVU14YjJGWFVteFlNa3BvWW0wMWJHTnBRWFJpYlRsNlpFZEdNR041UVhSaVJ6bHVZa2RXTWxwWGQyZGFXRXA1WWpOSloweFhhMmRsTWxwd1lrZFdPVWxETVhSWldFRm5UVVJ3YUU5cVFTOUpRekV5WW1sQmRGbDZjR2hKUjNod1dXMDVkMlJZVFdkTVYwWnFTVVJKWjB4WFNUWlpVMEV5VGtkeloxcFhOVzVpUjJ4NllVTXhjazE2U1hWaVYzUm9TVU14ZEZsWVFXZE5SSEJvVDJwRkwwbERNVEppYVVGMFdYcHdhRWxIZUhCWmJUbDNaRmhOWjB4WFJtcEpSRWxuVEZkSk5sbFRRVEpPUjNObllXMUdkMWxYTld4YVdFNXNURmR6ZWsxcE5YUmhNa1ZwVEVOS2JWcHRNWGRhVjJOblRGaHJaMHhYTlhaak0xSnJZVmMwWjB4WGFIQmFSMVptV1cxR2RXSnRWbmxKUXpGMVlqTk9NRmxZVW5wSlF6RnpZakprYzFwWVdteGlRMEpzWTI1S2RtTnBRWFJoVTBJeVlWZFNiR0o1TVhKTWJURnlaR2xCZEdGVFFteGliV1J6WVZoT2IweFhjM3BOYVRWMFlUSkZaMHhYYTJkbE1scHdZa2RXT1VsRE1YUlpXRUZuVFVSd01rbERNWFJaV0VGblRWUndhRWxETVhSWldFRm5UV3B3ZWxCNVFYUlplbkJvU1VkT2RtTklhMmRNVjAwMlpHbENhbUl6UWpWSlF6RnFUMjVOWjFreU9YZGxVMEZ1V1ZjMWNHSlhWV2RaVjNoM1lVZEZaMU5GVVdkYVZ6VnVURlpPTjJNeVZtaGpNamwxWmxOQ1JtVXlWbmRoV0U1MldrZFdPVWxJZEhWWlZ6RnNabE0xZEdFeldXNUphWGRwV20xYWRHTkhWbTVKUXpFMVNVTXhkV0l6VGpCYVIyeDFTVU14YjJGWFVteFlNa3BvWW0wMWJHTnBRWFJpYlRsNlpFZEdNR041UVhSaVJ6bHVZa2RXTWxwWGQyZGFXRXA1WWpOSloweFhhMmRrYld4cldsYzRkR0Y1TlhSaE0xbG5URmRyWjJGdFJuZFpWelZzV2xoT2JFeFhjM3BOYVRWMFlUSkZaMHhYYTJkbE1scHdZa2RXT1VsRE1YUlpXRUZuVFVSd01rbERNWFJaV0VGblRWUndhRWxETVhSWldFRm5UV3B3ZWxCNVFYUlplbkJvU1VkT2RtTklhMmRNVjAwMlpHbENhbUl6UWpWSlF6RnFUMjVOWjFreU9YZGxVMEZ1V1ZjMWNHSlhWV2RaVjNoM1lVZEZaMU5GVVdkaGJrSjFURlpPTjJNeVZtaGpNamwxWmxOQ1JtVXlWbmRoV0U1MldrZFdPVWxJZEhWWlZ6RnNabE0xZEdFeldXNUphWGRwV20xYWRHTkhWbTVKUXpFMVNVTXhkV0l6VGpCYVIyeDFTVU14YjJGWFVteFlNa3BvWW0wMWJHTnBRWFJpYlRsNlpFZEdNR041UVhSaVJ6bHVZa2RXTWxwWGQyZGFXRXA1WWpOSloweFhhMmRLTWtaMVlWY3hiRWxIUm5OalIyaG9TVVZvUlVsSFZuVmFlVEZVWlROT2JGbFlUblppYmpCblVsaDBiR05IYkhwaU1sSnNabE5DTjJKdFJuUmFXREIxWWxkME1rcDVRWFJqTTAxblRVUkJOazFFUVRaTlJFVjFUVVJCZDBsRE1USmFia3BvWWxkV2VrbEVSV2RNV0UxblRYcEpkMlZFVFhsTlEwRnVaRWRvTVdKWFNYVmhia0pzV25samFVeERTbTFhYlRGM1dsZGpaMHhZYTJkTVZ6VjJZek5TYTJGWE5HZE1WMmh3V2tkV1psbHRSblZpYlZaNVNVTXhkV0l6VGpCWldGSjZTVU14YzJJeVpITmFXRnBzWWtOQ2JHTnVTblpqYVVGMFlWTkJibGxYTlhCaVYxVm5XVmQ0ZDJGSFJXZFRSVkZuV2xjMWJreFdUamRqTWxab1l6STVkV1pUUWtabE1sWjNZVmhPZGxwSFZqbEpTSFIxV1ZjeGJHWlROWFJoTTFsdVNVTXhlbU41UVhkTlJHOTNUWHB2ZDAxRE5IZE5SRUZuVEZoYWJXTnRSblJhV0UxblRWTkJkR041UVhwTmFrSTBUWHBKZDBsRFpEQmhTRlowV1drMWNXTkhWbTVLZVVwa1RFTktlbHBYWkhSYVZ6VXdZM2xKTmxkNVNtMWFiVEYzV2xkaloweFlhMmRNVnpWMll6TlNhMkZYTkdkTVYyaHdXa2RXWmxsdFJuVmliVlo1U1VNeGRXSXpUakJaV0ZKNlNVTXhjMkl5WkhOYVdGcHNZa05DYkdOdVNuWmphVUYwWVZOQ2VscFhaRGRqTWxadVlsZFdkV1JFYjNkTk1sSTVURzB4Y21ScFFYUmlWMFozU1VSQk5tUnBRWFJaZW5BeVNVZDRjRmx1WjNsT2FsVm5URmhuZVU1cVZYUmpSMFo1V1ZjeGVrbERaSE5pTWpseVdWZG9iRmxYVVhSak1uaHdXVEpXZWxCVVZUWmpiVTEwWWtjNWRtRXlSbTlhVjBaclVGUlJkMDl0U20xamJVWjBXbGhOT1U1cWNIUmFWREY2WkVkR2VVOXRSbmhNVnpGMldrZFZPVTFwWTJkTVdFSjVXbGhPYkdSRFFucGlSemt6U1VNeE1HUlhOV3hKUjBaMVlWY3hhR1JIYkhaaWFVRjBXbTFzYzJSSFZubFlNazUyWWxoQ2MxcFlaMmRLTWpGMlpHMXNiRkJZWkdoa1IxWjVZbGRHZVdFeE9XaGliV3gwV2xNMWQySnRZMmRYTTJSb1pFZFdlV0pYUm5saE1UQTNWM3BDWkdNeVRtaGlSMVU1VEZSRk1rOXFXVEJOUTBKaVlWYzFaRTh4ZEhCaWJERmlaREpHTUZwWVNuUlpXRXB5V0ZOQ2RtUnRWbmxpUjBZMVVGUkJOazFEWTJkTVYwNTVXbWxCZVU1NVFYUmpSMncwV0RKYWRHUkRRalZrV0Zrd1RXcENkMDFVUW5OYVUwSXlZVmRTYkdKNU1YSmxNMDVzV2pJeGJHSnVVVFpOUkU1clpsTTFkR0V6V1dsWVdEQnpTVzA1TVdSSVFqRmtTRTFwVDJ4ME4wbHRXbkJpUjFWcFQybEthR0p0YkhSYVUwSm9Za2hDYjFsVFFrbFNRMEpzWW0xamRGVjZSV2RTVkVWblZGZEdjVnBZVGpCaFYwMW5WVWhLY0dKdFRteE1iVEZ5WkdsSmMwbHVVbTlrVnpGcFNXcHZhV1JIYURGaVYwbDFZVzVDYkZwNVNYTkpiWGhvWW0xamFVOXBTbXhpYldOcFpsTjROMGx0V25CaVIxVnBUMmxLYUdKdGJIUmFVMEpvWWtoQ2IxbFRRa2xTUTBKeFkwYzBkRlY2UldkU1ZFVm5WRmRHY1ZwWVRqQmhWMDFuVlVoS2NHSnRUbXhNYlRGeVpHbEpjMGx1VW05a1Z6RnBTV3B2YVdSSGFERmlWMGwxWVc1Q2JGcDVTWE5KYlhob1ltMWphVTlwU25GalJ6UnBabFl4T1NKOQ==
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
