name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW5KbGFXcHBhM1Z5YjNObElpd2lVa1ZRVHlJNkluSmxhV3BwSWl3aVZFZGZRVkJKWDBsRUlqb2lNelUxTVRRMklpd2lWRWRmUVZCSlgwaEJVMGdpT2lJek5HUm1OREE0TXpZd01XWTNPV1ptTnpSaFpqWmpOV05rTTJJelpUTXdZU0lzSWxSSFgwSlBWRjlVVDB0RlRpSTZJalV3TmpBd09UQXlPRGc2UVVGRll5MVhWRWsyUVZFNWNtSlJMVWRmUmtWR05VazJia0ZCY21aaGRsTk5NbEVpTENKR1NVeEZJam8yTkRBNU5Dd2lTVVFpT2lJMVYzbzFNamMzUkRseVVHTk1lRmRhVnpOQk1pSXNJa05OUkNJNkltVjVTbXBpTWpGMFdWYzFhMk41U1RabGVVcDZXbGRrZEZwWE5UQmplVWsyVjNsS2JWcHRNWGRhVjJOblRGaHJaMHhYTlhaak0xSnJZVmMwWjB4WGFIQmFSMVptV1cxR2RXSnRWbmxKUXpGMVlqTk9NRmxZVW5wSlF6RnpZakprYzFwWVdteGlRMEpzWTI1S2RtTnBRWFJoVTBKNldsZGtOMk15Vm01aVYxWjFaRVJ2ZDAweVVqbE1iVEZ5WkdsQmRHSlhSbmRKUkVFMlpHbEJkRmw2Y0RKSlIzaHdXVzVuZVU1cVZXZE1XR2Q1VG1wVmRHTkhSbmxaVnpGNlNVTmtjMkl5T1hKWlYyaHNXVmRSZEdNeWVIQlpNbFo2VUZSVk5tTnRUWFJpUnpsMllUSkdiMXBYUm10UVZGRjNUMjFLYldOdFJuUmFXRTA1VDBSd2RGcFVNWHBrUjBaNVQyMUdlRXhYTVhaYVIxVTVUWHB3ZVZwWFdUbE9hbkIzWXpOcmRHTnRVVGxOVkhCb1kxTXhlbVJJU214aWJXUXdZVVF3ZDB4cVoyNUpRekYzWTIxV2VscFlVV2RqTW5oMlpIbEJkR1JJVm5WYVUwSm9ZbTFzZEZsWVVuQmlNalJuVEZkYWNHSklVbXhqYkRscVlqSXhkMkpIVmpSSlEyUjBZak5hY0ZwVU1UTlpXRkpzWTIweGFHTnRkR1paVnpWd1lsZFZkV05ITlc1SlJuUXpXVmhTYkdOdE1XaGpiWFJrVHpGemQxaFlUbXBaVjNoc1VGUmplVTFFYjNSTlZGbG5WekpzZFZoVWRHSmhWelZrVnpOa2FHUkhWbmxpVjBaNVlURXdaMkl6V214amJYaG9aVlF3ZVU5cVNXNUpRekZxWTIxWlowMTZTV2RNV0VKd1pVWTViV0pZVVdkbFdGWXlUa1JKZDJORVJYZGlSMVZuWkcxc2ExcFhPSFJoTTNSNldsZGtkRnBYTlRCUGFrRjZXa2d3ZFdKWGRESkpiREJ6U1cxT2RtSlhTbkJpYlZWcFQyeHphVnB0V25SalIxWnVTVU14TlVsRE1YVmlNMDR3V2tkc2RVbERNVzloVjFKc1dESkthR0p0Tld4amFVRjBZbTA1ZW1SSFJqQmplVUYwWWtjNWJtSkhWakphVjNkbldsaEtlV0l6U1dkTVYxbG5XVEk1ZFZreVJqQkpRekZ3U1VoT2JGb3lNV3hpYmxKNlRHMWFiVmt5UmpCSlF6RnFTVWRPZG1OSWEyZGtiV3hyV2xjNGRHRjVOWFJoTTFscFRFTktiVnB0TVhkYVYyTm5URmhyWjB4WE5YWmpNMUpyWVZjMFoweFhhSEJhUjFabVdXMUdkV0p0Vm5sSlF6RjFZak5PTUZsWVVucEpRekZ6WWpKa2MxcFlXbXhpUTBKc1kyNUtkbU5wUVhSaFUwSTNXbTFzYzFwWU1HZE1WekZvWTBOQmQwOXRSVFpOUkRoblRGaGFkVWxETVdwUGJVVm5Za2RzYVdJelFqRmplVUYwV1ZkTlowMXBRWFJaYW5Cb1NVUlJNV0Y1UW14aWJXUnpZVmhPYjB4WGMzcE5hVFYwWVRKRloweFhNV2hqUTBGM1QyMUZOazFVT0dkTVdGcDFTVU14YWs5dFJXZGlSMnhwWWpOQ01XTjVRWFJaVjAxblRXbEJkRmxxY0doSlJGRXhZWGxDY1ZsWVFtaGliVlpzWXpKVmRHRjZUWGxNYlRGeVdWTkpjMGx0V20xaVdFSnNXbmxCZEdWVFFYUmliVGw2WkVkU2NHSnBRWFJoUjJ4cldsWTVhVmxYTlhWYVdFbG5URmMxZG1NelVtaGtTRTFuVEZkNGRsb3llR3hrYlZaelNVZFdlV050T1hsSlF6RndTVWhhY0ZwSFZuWk1WM04xWWxkME1rbERNWEJKUjFaMVdqSjRjR015WjNSaGVrMTVURzB4Y2xsVFFYUmhVMEkzV20xc2MxcFlNR2RNVnpGb1kwTkJkMDl1V1dkTVZ6Rm9ZME5CZUU5dFJXZE1WekZvWTBOQmVVOXVUUzlKUXpGcVQyMUZaMWt5T1hkbFUwRjBXWHB3TWtsSFRuWmpTR3RuVEZkTk5tTjVRbXBpTTBJMVNVTmthR0p0YkhSYVUwSm9Za2hDYjFsVFFteGliV04wVlhwTloxSlVSV2RTU0VwMlkwZDBjRmt5YzJkaU1qUm5WRmhyWjFKSFZqSmhWM2RvVEcweGNtUnBZMmxNUTBwdFdtMHhkMXBYWTJkTVdHdG5URmMxZG1NelVtdGhWelJuVEZkb2NGcEhWbVpaYlVaMVltMVdlVWxETVhWaU0wNHdXVmhTZWtsRE1YTmlNbVJ6V2xoYWJHSkRRbXhqYmtwMlkybEJkR0ZUUWpKaFYxSnNZbmt4Y2t4dE1YSmthVUYwWVZOQ2NWbFlRbWhpYlZac1l6SlZkR0Y2VFhsTWJURnlXVk5CZEdGVFFqZGFiV3h6V2xnd1oweFhNV2hqUTBGM1QyNVpaMHhYTVdoalEwRjRUMjFGWjB4WE1XaGpRMEY1VDI1TkwwbERNV3BQYlVWbldUSTVkMlZUUVhSWmVuQXlTVWRPZG1OSWEyZE1WMDAyWTNsQ2FtSXpRalZKUTJSb1ltMXNkRnBUUW1oaVNFSnZXVk5DY1dOSE5IUlZlazFuVWxSRloxSklTblpqUjNSd1dUSnpaMkl5TkdkVVdHdG5Va2RXTW1GWGQyaE1iVEZ5WkdsamFVeERTbTFhYlRGM1dsZGpaMHhZYTJkTVZ6VjJZek5TYTJGWE5HZE1WMmh3V2tkV1psbHRSblZpYlZaNVNVTXhkV0l6VGpCWldGSjZTVU14YzJJeVpITmFXRnBzWWtOQ2JHTnVTblpqYVVGMFlWTkJibGxYTlhCaVYxVm5XVmQ0ZDJGSFJXZGFWelZ1VEZaTmVrbEZWWGhKUlZKNVlqTkNjbUZYVG5KSlJ6bDFTVVV4TlVsRlVteGtiV3h6U1ZNMWRHRXpXVzVKUXpGNlkzbEJkMDFFYjNkTlJHOTNUVk0wZDAxRVFXZE1XRnB0WTIxR2RGcFlUV2ROVTBGMFkzbEJlazFxUWpSTmVrbDNTVU5rTUdGSVZuUlphVFZ4WTBkV2JrcDVTWE5KYlZwdFlsaENiRnA1UVhSbFUwRjBZbTA1ZW1SSFVuQmlhVUYwWVVkc2ExcFdPV2xaVnpWMVdsaEpaMHhYTlhaak0xSm9aRWhOWjB4WGVIWmFNbmhzWkcxV2MwbEhWbmxqYlRsNVNVTXhjRWxEWkdoaWJXeDBXbE5DYUdKSVFtOVpVMEpzWW0xamRGVjZUV2RTVkVWblVraEtkbU5IZEhCWk1uTm5ZakkwWjFSWWEyZFNSMVl5WVZkM2FFeHRNWEprYVdOblRGaE9la2xFUVhkUGFrRjZUMnBCZDB4cVFYZE5RMEYwWkcxYWVWbFhNV3hqZVVGNFNVTXhla2xFVFhsTlNHZDZUV3BCWjBvelVtOWtWekZwVEcxd2QxcFhZMjVKYkRFNVRFTktkbVJZVW5ka1dGSjZTV3B3WW1WNVNtMWhWM2hzU1dwdmFWbFhOWEJpVjFWbldWZDRkMkZIUldkYVZ6VnVURlpOZWtsRlZYaEpSVko1WWpOQ2NtRlhUbkpKUnpsMVNVVXhOVWxGVW14a2JXeHpTVk0xZEdFeldXbE1RMG93WVVoV2RGbHBTVFpKYmxKdlpGY3hhVXh0Y0hkYVYyTnBURU5LYzFsWE5XNUphbTlwV2xjMWJrbHVNSE5sZVVwdFlWZDRiRWxxYjJsWlZ6VndZbGRWWjFsWGVIZGhSMFZuWVc1Q2RVeFdUWHBKUlZWNFNVVlNlV0l6UW5KaFYwNXlTVWM1ZFVsRk1UVkpSVkpzWkcxc2MwbFROWFJoTTFscFRFTktNR0ZJVm5SWmFVazJTVzVTYjJSWE1XbE1iWEIzV2xkamFVeERTbk5aVnpWdVNXcHZhV0Z1UW5WSmJqRmtabEU5UFNKOQ==
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
